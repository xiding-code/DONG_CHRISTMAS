
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pink Christmas Magic</title>
    <style>
        body { margin: 0; overflow: hidden; background: #200515; font-family: -apple-system, sans-serif; touch-action: none; }
        #container { position: relative; width: 100vw; height: 100vh; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; align-items: center; padding-top: 10vh; box-sizing: border-box; }
        h1 { color: #ffb6c1; text-shadow: 0 0 15px #ff69b4; letter-spacing: 3px; font-size: 1.6em; text-align: center; }
        #status { margin-top: 5px; color: #fff; font-size: 12px; background: rgba(255,105,180,0.2); padding: 5px 15px; border-radius: 15px; }
        #yt-player { position: absolute; top: -100px; left: -100px; width: 1px; height: 1px; visibility: hidden; }
        #iphone-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30,5,15,0.96); backdrop-filter: blur(20px); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; pointer-events: auto; }
        #iphone-canvas.active { display: flex; }
        #photo-frame { width: 85%; height: 60%; background: #000; border-radius: 25px; box-shadow: 0 0 40px rgba(255,105,180,0.5); border: 1px solid #ff69b4; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #display-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #back-btn { margin-top: 25px; padding: 15px 50px; background: #ff69b4; color: white; border: none; border-radius: 35px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(255,105,180,0.5); }
        .controls { position: absolute; bottom: 5vh; pointer-events: auto; z-index: 110; display: flex; flex-direction: column; gap: 12px; width: 80%; max-width: 300px; }
        button, .upload-btn { padding: 14px; background: rgba(255,105,180,0.2); color: #fff; border: 1.5px solid #ff69b4; border-radius: 30px; cursor: pointer; font-weight: bold; text-align: center; backdrop-filter: blur(10px); font-size: 14px; }
        #clear-btn { border-color: #ff4d4d; color: #ffcccc; background: rgba(255,0,0,0.1); }
        #file-input { display: none; }
        #preview-container { position: absolute; top: 10px; right: 10px; width: 80px; height: 110px; border-radius: 12px; overflow: hidden; border: 1px solid #ff69b4; transform: scaleX(-1); opacity: 0.7; z-index: 5; background: #000; }
        #video-preview { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>
    <div id="container">
        <div id="yt-player"></div>
        <div id="ui-layer">
            <h1 id="main-title">LAST CHRISTMAS<br>PINK MAGIC</h1>
            <div id="status">‚ú® Waiting for Magic...</div>
            <div class="controls">
                <button id="start-btn">ÂºÄÂêØÈ≠îÊ≥ï & Êí≠Êîæ Wham!</button>
                <div id="action-btns" style="display:none; flex-direction: column; gap: 12px; width: 100%;">
                    <label class="upload-btn" for="file-input">‚ûï Ê∑ªÂä†ËÆ∞ÂøÜ</label>
                    <button id="clear-btn">üóëÔ∏è ‰∏ÄÈîÆÊ∏ÖÁ©∫ÊâÄÊúâÁÖßÁâá</button>
                </div>
                <input type="file" id="file-input" accept="image/*" multiple>
            </div>
        </div>
        <div id="iphone-canvas">
            <div id="photo-frame"><img id="display-img" src=""></div>
            <button id="back-btn">ËøîÂõûÁÖßÁâáÁêÉ</button>
        </div>
        <div id="preview-container"><video id="video-preview" autoplay playsinline></video></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        let scene, camera, renderer, treeGroup, photoBall, snowParticles, clock, ytPlayer;
        let isGallery = false, isStillLife = false;
        const statusEl = document.getElementById('status');
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('yt-player', {
                height: '0', width: '0',
                videoId: 'E8gmARGvPlI',
                playerVars: { 'autoplay': 0, 'loop': 1, 'playlist': 'E8gmARGvPlI' },
                events: { 'onReady': () => console.log("Music Ready") }
            });
        }

        function initThree() {
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(65, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1, 18);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('container').appendChild(renderer.domElement);

            treeGroup = new THREE.Group();
            const positions = [], colors = [];
            for(let i=0; i<12000; i++){
                const h = Math.random() * 12;
                const r = ((12-h)/12) * 5 * Math.pow(Math.random(), 0.7);
                const a = Math.random() * Math.PI * 2;
                positions.push(Math.cos(a)*r, h - 6, Math.sin(a)*r);
                const col = new THREE.Color().setHSL(0.9, 0.8, 0.5 + Math.random()*0.3);
                colors.push(col.r, col.g, col.b);
            }
            const treeGeo = new THREE.BufferGeometry();
            treeGeo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            treeGeo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            treeGroup.add(new THREE.Points(treeGeo, new THREE.PointsMaterial({size:0.08, vertexColors:true, transparent:true, blending:THREE.AdditiveBlending})));
            scene.add(treeGroup);

            const snowP = [];
            for(let i=0; i<4000; i++) snowP.push((Math.random()-0.5)*50, Math.random()*30, (Math.random()-0.5)*50);
            const snowGeo = new THREE.BufferGeometry();
            snowGeo.setAttribute('position', new THREE.Float32BufferAttribute(snowP, 3));
            snowParticles = new THREE.Points(snowGeo, new THREE.PointsMaterial({color:0xffb6c1, size:0.1, transparent:true, opacity:0.6}));
            scene.add(snowParticles);

            photoBall = new THREE.Group();
            scene.add(photoBall);
            scene.add(new THREE.AmbientLight(0xffffff, 1.2));

            const handleInteract = (x, y) => {
                if (!isGallery || isStillLife) return;
                mouse.x = (x / window.innerWidth) * 2 - 1;
                mouse.y = -(y / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(photoBall.children);
                if (intersects.length > 0) {
                    isStillLife = true;
                    document.getElementById('display-img').src = intersects[0].object.userData.src;
                    document.getElementById('iphone-canvas').classList.add('active');
                }
            };

            window.addEventListener('mousedown', (e) => handleInteract(e.clientX, e.clientY));
            window.addEventListener('touchstart', (e) => handleInteract(e.touches[0].clientX, e.touches[0].clientY));
            document.getElementById('back-btn').onclick = () => {
                isStillLife = false; document.getElementById('iphone-canvas').classList.remove('active');
            };
            
            document.getElementById('clear-btn').onclick = () => {
                while(photoBall.children.length > 0) photoBall.remove(photoBall.children[0]);
                toggleGallery(false);
            };
            animate();
        }

        function toggleGallery(show) {
            if (isGallery === show || isStillLife || (show && photoBall.children.length === 0)) return;
            isGallery = show;
            if (show) {
                gsap.to(treeGroup.scale, { x: 0, y: 0, z: 0, duration: 1 });
                photoBall.children.forEach((m, i) => {
                    const phi = Math.acos(-1 + (2 * i) / photoBall.children.length);
                    const theta = Math.sqrt(photoBall.children.length * Math.PI) * phi;
                    gsap.to(m.position, {
                        x: 9 * Math.sin(phi) * Math.cos(theta),
                        y: 9 * Math.sin(phi) * Math.sin(theta),
                        z: 9 * Math.cos(phi),
                        duration: 1.2, ease: "power2.out"
                    });
                    gsap.to(m.scale, { x: 1, y: 1, z: 1, duration: 0.8 });
                    m.lookAt(0,0,0);
                });
            } else {
                gsap.to(treeGroup.scale, { x: 1, y: 1, z: 1, duration: 1 });
                photoBall.children.forEach(m => gsap.to(m.position, { x: 0, y: 0, z: 0, duration: 1 }));
            }
        }

        document.getElementById('file-input').onchange = (e) => {
            const loader = new THREE.TextureLoader();
            Array.from(e.target.files).forEach(f => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const b64 = event.target.result;
                    loader.load(b64, (tex) => {
                        const mesh = new THREE.Mesh(
                            new THREE.PlaneGeometry(3 * (tex.image.width/tex.image.height), 3),
                            new THREE.MeshBasicMaterial({map:tex, side:2})
                        );
                        mesh.scale.set(0,0,0); mesh.userData.src = b64; photoBall.add(mesh);
                    });
                };
                reader.readAsDataURL(f);
            });
            statusEl.innerText = "Photos Added!";
        };

        async function setupAI() {
            const video = document.getElementById('video-preview');
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            const hands = new Hands({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
            hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6 });
            hands.onResults((res) => {
                if (!res.multiHandLandmarks) return;
                const lms = res.multiHandLandmarks;
                if (lms.length === 2 && Math.hypot(lms[0][9].x - lms[1][9].x, lms[0][9].y - lms[1][9].y) < 0.1) toggleGallery(false);
                lms.forEach((lm, i) => {
                    if (res.multiHandedness[i].label === "Right" && isGallery && !isStillLife) {
                        gsap.to(photoBall.rotation, { y: -(lm[9].x - 0.5) * Math.PI * 2, duration: 0.5 });
                    }
                    if (Math.hypot(lm[4].x-lm[8].x, lm[4].y-lm[8].y) < 0.04) toggleGallery(true);
                });
            });
            const loop = async () => { await hands.send({ image: video }); requestAnimationFrame(loop); };
            loop();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (!isGallery) treeGroup.rotation.y += 0.003;
            if (snowParticles) {
                const pos = snowParticles.geometry.attributes.position.array;
                for(let i=1; i<pos.length; i+=3) {
                    pos[i] -= 0.03; if (pos[i] < -12) pos[i] = 15;
                }
                snowParticles.geometry.attributes.position.needsUpdate = true;
            }
            renderer.render(scene, camera);
        }

        document.getElementById('start-btn').onclick = async function() {
            this.style.display = 'none';
            document.getElementById('action-btns').style.display = 'flex';
            if(ytPlayer && ytPlayer.playVideo) ytPlayer.playVideo();
            initThree();
            await setupAI();
        };
    </script>
</body>
</html>
